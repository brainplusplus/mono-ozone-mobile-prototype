var OWF,Ozone;util.namespace("jc2cui.mapWidget");jc2cui.mapWidget=function(e){"use strict";function w(){if(!t||t.useShim){if(!l){l=document.createElement("iframe");l.frameBorder=0;l.scrolling="no";l.style.position="absolute";l.style.top="0px";l.style.left="0px";l.style.width="100%";l.style.height="100%";l.style["background-color"]="gray";$("body").append(l)}else{l.style.display="block"}++c}}function E(){if(l&&--c===0){l.style.display="none"}}function S(e,t,n,r,i,s){n=n||160;r=r||250;w();e.dialog({preferredHeight:n,preferredWidth:r,height:Math.min(n,p.height-20),width:Math.min(r,p.width-20),modal:true,title:t,buttons:i,close:function(t,n){E();e.remove();if(s){s()}}})}function x(e,t,n,r,i){if(i&&d[i]){return}d[i]=true;var s=$("<div>"+e+"</div>");S(s,t,n,r,{Ok:function(){s.dialog("close")}},function(){delete d[i]})}function T(e){x(e,"Error")}function N(e){$.ajax({url:"config/"+e.config+".json",dataType:"json",success:function(e,n){t=e;$.ajax({url:t.path,dataType:"script",timeout:2e4,success:function(e,n){if(jc2cui.mapWidget.renderer){var i=t.constraints,s;if(i){if($.browser.msie&&i.ie){i=i.ie}else if($.browser.mozilla&&i.firefox){i=i.firefox}else if($.browser.chrome&&i.chrome){i=i.chrome}s=parseInt($.browser.version,10).toString();if(i[s]){i=i[s]}else if(i["default"]){i=i["default"]}t.constraints=i}if(t.options){OWF.Preferences.getUserPreference({namespace:r,name:"options",onSuccess:function(e){if(e&&e.value){var n=JSON.parse(e.value);$.extend(true,t.options,n)}jc2cui.mapWidget.renderer.init(t)},onFailure:function(e,n){if(n!==undefined&&e!=="undefined : undefined"){T("Got an error getting preferences! Status Code: "+n+" . Error message: "+e)}jc2cui.mapWidget.renderer.init(t)}})}else{jc2cui.mapWidget.renderer.init(t)}}else{T("map renderer "+t.name+" at "+t.path+" failed to initialize properly.")}},error:function(e,n,r){var i="Error loading "+t.name+" renderer script "+t.path;if(n&&n!=="error"){i+=": "+n}T(i)}})},error:function(t,n,r){var i="Error loading "+e.name+" renderer config "+e.config;if(n&&n!=="error"){i+=": "+n}T(i)}})}function C(e){var t='<div id="choose-renderer" class="selection">Choose the map renderer to be used by this widget:<br>';$.each(e,function(e,n){t+='<div><label><input type="radio" name="renderer" value='+e+"> "+n.name+"</label></div>";if(n.note){if(typeof n.note==="string"){n.note=[n.note]}$.each(n.note,function(e,n){t+='<span class="small">'+n+"</span><br>"})}});t+="</div>";v=$(t).appendTo($("body"));v.css({left:((p.width-v.width())/2).toString()+"px",top:((p.height-v.height())/2).toString()+"px"}).show();$('input[name="renderer"]',v).click(function(){OWF.Preferences.setUserPreference({namespace:r,name:"renderer",value:JSON.stringify(e[this.value]),onFailure:function(e,t){T("Error updating preferences. Status Code: "+t+" . Error message: "+e)}});N(e[this.value]);v.remove();v=null})}function k(){var e="config/mapWidgetConfig.json";$.ajax({url:e,dataType:"json",success:function(e){if(!e){T("Error loading map widget configuration: No data");return}if(!e.renderers){T("Missing renderer configuration attribute in mapConfig file.");return}if(e.renderers.length>1){C(e.renderers)}else{N(e.renderers[0])}},error:function(t,n,r){var i="Error loading map widget configuration: "+e;if(n&&n!=="error"){i+=" "+n}T(i)}})}function L(){OWF.Preferences.getUserPreference({namespace:r,name:"renderer",onSuccess:function(e){var t;if(e&&e.value){t=JSON.parse(e.value)}if(t){N(t)}else{k()}},onFailure:function(e,t){if(t!==undefined&&e!=="undefined : undefined"){T("Got an error getting preferences! Status Code: "+t+" . Error message: "+e)}k()}})}function A(e,t,n){jc2cui.mapWidget.sidebar.addOverlay(e,t||(e===jc2cui.mapWidget.USER_DRAWN_OVERLAY?jc2cui.mapWidget.USER_DRAWN_OVERLAY:null),n,e===jc2cui.mapWidget.USER_DRAWN_OVERLAY)}function O(e,t,r){e=typeof e==="string"?JSON.parse(e):e;if(e.id===n){return}var i=typeof t==="string"?JSON.parse(t):t,s=[];if(!$.isArray(i)){i=[i]}$.each(i,function(n,i){r.process(i,s,e,t)});if(s.length>0){jc2cui.mapWidget.error({sender:e?e.id:"",type:r.type,msg:t,error:s.join(",")})}}function M(e,t){OWF.Eventing.subscribe(e,function(n,r){O(n,r,{type:e,process:t})})}function _(e,n,r,i){if(!e.overlayId){e.overlayId=r.id}if(!e.name){e.name=e.overlayId}if(jc2cui.mapWidget.renderer){jc2cui.mapWidget.renderer.createOverlay(e,r,i)}if(t.sidebar){A(e.overlayId,e.name,e.parentId)}}function D(e,n,r,s){if(!e.overlayId){e.overlayId=r.id}if(jc2cui.mapWidget.renderer){jc2cui.mapWidget.renderer.removeOverlay(e.overlayId,r,s)}if(t.sidebar){jc2cui.mapWidget.sidebar.removeOverlay(e.overlayId)}if(e.overlayId===jc2cui.mapWidget.USER_DRAWN_OVERLAY){i=false}}function P(e,n,r,i){if(!e.overlayId){e.overlayId=r.id}if(jc2cui.mapWidget.renderer){jc2cui.mapWidget.renderer.setOverlayVisibility(e.overlayId,true,r,i)}if(t.sidebar){jc2cui.mapWidget.sidebar.showOverlay(e.overlayId)}}function H(e,n,r,i){if(!e.overlayId){e.overlayId=r.id}if(jc2cui.mapWidget.renderer){jc2cui.mapWidget.renderer.setOverlayVisibility(e.overlayId,false,r,i)}if(t.sidebar){jc2cui.mapWidget.sidebar.hideOverlay(e.overlayId)}}function B(e,n,r,i){if(!e.overlayId){e.overlayId=r.id}if((e.parentId||e.clustering)&&jc2cui.mapWidget.renderer){if(!jc2cui.mapWidget.renderer.updateOverlay(e,r,i)){n.push("Unable to find overlay "+e.overlayId);return}}if(t.sidebar){if(!jc2cui.mapWidget.sidebar.updateOverlay(e.overlayId,e.name,e.parentId)){n.push("Unable to find overlay "+e.overlayId);return}}}function j(e,n,r,i){if(!e.overlayId){e.overlayId=r.id}if(e.zoom===undefined){e.zoom=false}if(!e.url){n.push("No url in map.feature.plot.url message");return}if(!e.featureId){n.push("No featureId in map.feature.plot.url message");return true}if(t.sidebar){A(e.overlayId)}if(jc2cui.mapWidget.renderer){var s=e.format?e.format.toLowerCase():"kml";switch(s){case"kml":jc2cui.mapWidget.renderer.loadKml(e,r,i);break;case"wms":jc2cui.mapWidget.renderer.loadWms(e,r,i);break;default:n.push("Feature format: "+e.format+" not yet supported");return}}}function F(e,n,r,i){if(e.format&&e.format.toLowerCase()!=="kml"){n.push("Feature format: "+e.format+" not yet supported");return}if(!e.overlayId){e.overlayId=r.id}if(!e.feature){n.push("No feature data in map.feature.plot message");return}if(!e.featureId){n.push("No featureId in map.feature.plot message");return}if(e.zoom===undefined){e.zoom=false}if(t.sidebar){A(e.overlayId)}if(jc2cui.mapWidget.renderer){jc2cui.mapWidget.renderer.parseKml(e,r,i)}}function I(e,n,r,i){if(!e.overlayId){e.overlayId=r.id}if(!e.featureId){n.push("No featureId in map.feature.plot.update message");return true}if((e.newOverlayId||e.clustering)&&jc2cui.mapWidget.renderer){if(!jc2cui.mapWidget.renderer.updateFeature(e,n,r,i)){return}}if(t.sidebar){if(!jc2cui.mapWidget.sidebar.updateFeature(e.overlayId,e.featureId,e.name,e.newOverlayId)){n.push("Unable to update feature "+e.featureId);return}}}function q(e,n,r,i){if(!e.overlayId){e.overlayId=r.id}if(!e.featureId){n.push("No featureId in map.feature.unplot message");return}if(jc2cui.mapWidget.renderer){jc2cui.mapWidget.renderer.removeFeature(e,r,i)}if(t.sidebar){jc2cui.mapWidget.sidebar.removeFeature(e.featureId,e.overlayId)}}function R(e,n,r,i){if(!e.overlayId){e.overlayId=r.id}if(!e.featureId){n.push("No featureId in map.feature.show message");return}if(e.zoom===undefined){e.zoom=false}if(jc2cui.mapWidget.renderer){jc2cui.mapWidget.renderer.showFeature(e,r,i);if(e.zoom){jc2cui.mapWidget.renderer.centerOnFeature({overlayId:e.overlayId,featureId:e.featureId,zoom:"auto"})}}if(t.sidebar){jc2cui.mapWidget.sidebar.showFeature(e.featureId,e.overlayId)}}function U(e,n,r,i){if(!e.overlayId){e.overlayId=r.id}if(!e.featureId){n.push("No featureId in map.feature.hide message");return}if(jc2cui.mapWidget.renderer){jc2cui.mapWidget.renderer.hideFeature(e,r,i)}if(t.sidebar){jc2cui.mapWidget.sidebar.hideFeature(e.featureId,e.overlayId)}}function z(e,t,n,r){if(e.range===undefined){t.push("No range in map.view.center.range message");return}if(jc2cui.mapWidget.renderer){jc2cui.mapWidget.renderer.zoomToRange(e,n,r)}}function W(e,t,n,r){if(!e.overlayId){e.overlayId=n.id}if(jc2cui.mapWidget.renderer){jc2cui.mapWidget.renderer.centerOnOverlay(e,n,r)}}function X(e,t,n,r){if(jc2cui.mapWidget.renderer){if(!e.overlayId){e.overlayId=n.id}if(!e.featureId){t.push("No featureId in map.view.center.feature message");return}jc2cui.mapWidget.renderer.centerOnFeature(e,n,r)}}function V(e,t,n,r){if(!e.location){t.push("No location in map.view.center.location message");return}if(jc2cui.mapWidget.renderer){jc2cui.mapWidget.renderer.centerOnLocation(e,n,r)}}function J(e,t,n,r){if(!e.bounds){t.push("No bounds in map.view.center.bounds message");return}if(jc2cui.mapWidget.renderer){jc2cui.mapWidget.renderer.centerOnBounds(e,n,r)}}function K(e,t,n,r){if(jc2cui.mapWidget.renderer){var i={requester:n.id},s=e.types===undefined,o,u;if(s||$.inArray("view",e.types)>=0){u=jc2cui.mapWidget.renderer.getViewStatus();$.extend(u,i);jc2cui.mapWidget.publishView(u)}if(s||$.inArray("format",e.types)>=0){u={formats:["kml","wms"]};$.extend(u,i);OWF.Eventing.publish("map.status.format",JSON.stringify(u))}if(s||$.inArray("about",e.types)>=0){o=jc2cui.mapWidget.renderer.info();u={version:"1.1.0",type:o.type,widgetName:"JC2CUI Map Widget - "+o.name};$.extend(u,i);OWF.Eventing.publish("map.status.about",JSON.stringify(u))}}}function Q(e,t,n,r){if(!e.overlayId){e.overlayId=n.id}if(!e.featureId){t.push("No featureId in map.feature.selected message");return}if(jc2cui.mapWidget.renderer){jc2cui.mapWidget.renderer.selected(e,n,r)}}function G(e,n){e=typeof e==="string"?JSON.parse(e):e;var r=n.overlayId||e.id,i=jc2cui.mapWidget.renderer?jc2cui.mapWidget.renderer.getDropLocation():{lat:0,lon:0},s=[],o,u,a=[],f;OWF.Eventing.publish("map.overlay.create",JSON.stringify({overlayId:r}));if(n.marker){if(t.sidebar){A(r)}f=n.name||n.marker.title;s.push('<kml xmlns="http://www.opengis.net/kml/2.2" xmlns:gx="http://www.google.com/kml/ext/2.2" xmlns:kml="http://www.opengis.net/kml/2.2" xmlns:atom="http://www.w3.org/2005/Atom">');s.push("<Placemark");s.push(' id="');s.push(n.featureId);s.push('">');if(f){s.push("<name>"+f+"</name>")}if(n.marker.details){s.push("<description>"+n.marker.details+"</description>")}if(n.marker.iconUrl){s.push("<Style><IconStyle><Icon><href>"+n.marker.iconUrl+"</href></Icon></IconStyle></Style>")}s.push("<Point><coordinates>"+i.lon+","+i.lat+",0</coordinates></Point></Placemark></kml>");s=s.join("");o={overlayId:r,featureId:n.featureId,zoom:n.zoom,name:f,feature:s};u=JSON.stringify(o);F(o,a,e,u);OWF.Eventing.publish("map.feature.plot",u);if(n.zoom&&jc2cui.mapWidget.renderer){jc2cui.mapWidget.renderer.centerOnFeature({overlayId:r,featureId:n.featureId,zoom:"auto"})}}if(n.feature){f=n.name||n.feature.name;if(n.feature.featureData){o={overlayId:r,featureId:n.featureId,name:f,zoom:n.zoom,format:n.feature.format,feature:n.feature.featureData};u=JSON.stringify(o);F(o,a,e,u);OWF.Eventing.publish("map.feature.plot",u)}if(n.feature.url){o={overlayId:r,featureId:n.featureId,name:f,zoom:n.zoom,format:n.feature.format,url:n.feature.url};u=JSON.stringify(o);j(o,a,e,u);OWF.Eventing.publish("map.feature.plot.url",u)}}if(a.length>0){jc2cui.mapWidget.error({sender:e?e.id:"",type:"Drag Drop",msg:n,error:a.join(",")})}}function Y(){M("map.overlay.create",_);M("map.overlay.remove",D);M("map.overlay.show",P);M("map.overlay.hide",H);M("map.overlay.update",B);M("map.feature.plot",F);M("map.feature.plot.url",j);M("map.feature.unplot",q);M("map.feature.show",R);M("map.feature.hide",U);M("map.feature.selected",Q);M("map.feature.update",I);M("map.view.center.overlay",W);M("map.view.center.feature",X);M("map.view.center.location",V);M("map.view.center.bounds",J);M("map.view.zoom",z);M("map.status.request",K)}function Z(e){var t,n,r,i;if(window.location.search.length){t=window.location.search.substring(1)}if(t){n=t.split("&")}for(i=0;i<n.length;++i){r=n[i].split("=");if(r.length===2&&r[0].toString().toLowerCase()===e.toString().toLowerCase()&&r[1].length){return r[1]}}}function et(){if(f){return}var e=['<div class="config">'];if(t.options){$.each(t.options,function(t,n){e.push('<div><input type="checkbox" id="'+t+'" name="'+t+'" />'+n.text||n+"</div>")});e.push("</div>");f=$(e.join("")).appendTo($("body"));$.each(t.options,function(e,n){var i=$("#"+e,f);if(n.value){i.prop("checked","checked")}i.click(function(){n.value=i[0].checked;if(jc2cui.mapWidget.renderer){jc2cui.mapWidget.renderer.optionChanged(e,n.value);OWF.Preferences.setUserPreference({namespace:r,name:"options",value:JSON.stringify(t.options),onFailure:function(e,t){T("Error updating preferences. Status Code: "+t+" . Error message: "+e)}})}})})}else{e.push("No configurable options</div>");f=$(e.join("")).appendTo($("body"))}S(f,"Configure",Math.min(250,p.height-20),Math.min(350,p.width-20),{Ok:function(){f.dialog("close")}},function(e,t){f=null})}function tt(){if(y){return}y=true;var e=['<form class="loadKml">',"<fieldset>",'<label for="overlay">Name:</label>','<input type="text" name="overlay" id="overlay" class="text ui-widget-content ui-corner-all" />','<label for="url">Enter URL to remote KML/KMZ:</label>','<input type="text" name="url" id="url" value="" class="text ui-widget-content ui-corner-all" />'],t,n,r,i=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/,s,o,u=window.FileReader!==undefined;if(u){e.push('<label for="files">Or choose local KML file(s):</label><input type="file" id="files" name="files" multiple size="47" class="ui-corner-all"/>')}e.push("</fieldset></form>");e=e.join("");t=$(e).appendTo($("body"));n=$("#overlay",t);r=$("#url",t);if(u){document.getElementById("files").addEventListener("change",function(e){o=e.target.files},false)}S(t,"Load KML",u?245:190,350,{Load:function(){var e=$.trim(n.val()),t=$.trim(r.val());if(!e.length){T("Please enter a name for this overlay.");return}if(!o&&(!i.test(t)||t.indexOf('"')>=0)){T("Please enter a valid URL.");return}if(t){OWF.Eventing.publish("map.overlay.create",JSON.stringify({overlayId:e}));s={overlayId:e,featureId:t,url:t};j(s,[],{id:"userLoaded"});OWF.Eventing.publish("map.feature.plot.url",JSON.stringify(s))}if(o){$.each(o,function(e,t){var r=new FileReader;r.onload=function(e){var r=$.trim(n.val());if(!r.length){T("Please enter a name for this overlay.");return}OWF.Eventing.publish("map.overlay.create",JSON.stringify({overlayId:r}));s={overlayId:r,featureId:t.name,name:t.name,feature:e.target.result};F(s,[],{id:"userLoaded"});OWF.Eventing.publish("map.feature.plot",JSON.stringify(s))};r.onerror=function(e){console.log("error",e);console.log(e.getMessage())};r.readAsText(t)})}$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},function(){y=false})}function nt(){var e,t=["<strong>JC2CUI Map Widget<hr>Widget Version</strong> - "],n=["<br><strong>Map Renderer</strong> - "],r="<br><strong>Common Map API Version</strong> - 1.1";if(jc2cui.mapWidget.renderer){e=jc2cui.mapWidget.renderer.info();n.push(e.name);n.push("<BR><strong>Map Type</strong> - ");n.push(e.type)}else{n.push("No map renderer configured")}$.ajax({url:"pkginfo.json",dataType:"json",success:function(i){t.push(i.version);t.push(" Release: ");t.push(i.release);t.push(r);t.push(n.join(""));if(e.entities){t.push("<hr>");t.push(e.entities)}x(t.join(""),"About",223,300,"about")},error:function(i,s,o){t.push("Unknown");t.push(r);t.push(n.join(""));if(e.entities){t.push("<hr>");t.push(e.entities)}x(t.join(""),"About",223,300,"about")}})}function rt(e){var t,i,s;owfdojo.config.dojoBlankHtmlUrl="../common/javascript/dojo-1.5.0-windowname-only/dojo/resources/blank.html";if(e.owfRelay){OWF.relayFile=e.owfRelay}OWF.Chrome.isModified({callback:function(e){var t=JSON.parse(e),n;if(t.success){n=t.modified?"updateHeaderButtons":"insertHeaderButtons";OWF.Chrome[n]({items:[{type:"help",itemId:"help",handler:function(e,t){nt()}},{type:"gear",itemId:"gear",handler:function(e,t){et()}},{type:"plus",itemId:"plus",handler:function(e,t){tt()}}]});if(JSON.parse(window.name).layout==="fit"){n=t.modified?"updateHeaderMenus":"addHeaderMenus";OWF.Chrome[n]({items:[{itemId:"load",text:"Load KML",icon:b+"images/plus.png",handler:function(e,t){tt()}},{itemId:"configure",text:"Configure",icon:b+"images/gear.png",handler:function(e,t){et()}},{itemId:"about",text:"About",icon:b+"images/help.png",handler:function(e,t){nt()}}]})}}}});OWF.DragAndDrop.onDrop(function(e){G(e.dragSourceId,e.dragDropData)});s=$("#map");s.mouseenter(function(){OWF.DragAndDrop.setDropEnabled(true)});s.mouseleave(function(){OWF.DragAndDrop.setDropEnabled(false)});m=$("#loaded");n=JSON.parse(Ozone.eventing.Widget.getInstance().getWidgetId()).id;r="jc2cui.mapWidget."+n;i=Z("config");if(i!==undefined){t={name:i,config:i};N(t)}else{L()}}function it(e){if(!e.owf){T("Missing owf configuration attribute in owfConfig file.");return}$.ajax({url:"/presentationGrails/static/js/widget/owf-widget-min.js",dataType:"script",cache:true,timeout:2e4,success:function(t,n){OWF.ready(function(){rt(e)})},error:function(t,n,r){var i="Error loading OWF script "+e.owf;if(n&&n!=="error"){i+=": "+n}T(i)}})}function st(e,t,n,r,i,s,o){var u={bounds:{southWest:{lat:e,lon:t},northEast:{lat:n,lon:r}},center:{lat:i,lon:s},range:o};return u}function ot(e,n,r,i){if(t.sidebar){jc2cui.mapWidget.sidebar.addItem(e,n,r,i)}}function ut(e,n){var r,i;if(t.sidebar){jc2cui.mapWidget.sidebar.addOverlay(e.id,e.name,n,n===undefined,true);for(r=0;r<e.children.length;r++){if(e.children[r].children.length){ut(e.children[r],e.id)}else{i={key:e.children[r].id,title:e.children[r].name,select:e.children[r].visibility,isFeature:true};ot(i,e.id)}}}}var t,n,r,i,s=0,o,u,a,f,l,c=0,h=$(window),p={height:h.innerHeight(),width:h.innerWidth()},d={},v,m,g,y,b;return $.extend(true,{init:function(e){b=document.location.href;b=b.substring(0,b.lastIndexOf("/")+1);it(e);var t;h.resize(function(){var e=h.innerWidth(),n=h.innerHeight();if(Math.abs(p.width-e)>3||Math.abs(p.height-n)>3){clearTimeout(t);t=setTimeout(function(){if(jc2cui.mapWidget.renderer){jc2cui.mapWidget.renderer.checkResize()}$(".ui-dialog-content:visible").each(function(){var t=$(this),r=t.data("ui-dialog")||t.data("uiDialog")||t.data("dialog"),i=r.uiDialog.width(),s=r.uiDialog.height(),o,u,a,f,l={};if(e<p.width){u=e-20;if(i>u){a=u}}else if(e>p.width&&i<r.options.preferredWidth){a=i+(e-p.width);a=Math.min(r.options.preferredWidth,a)}if(n<p.height){o=n-20;if(s>o){f=o}}else if(n>p.height&&s<r.options.preferredHeight){f=s+(n-p.height);f=Math.min(r.options.preferredHeight,f)}if(a&&a!==i){l.width=a}if(f&&f!==s){l.height=f}l.position=r.options.position;r.option(l)});p.width=e;p.height=n;if(v){v.css({left:((p.width-v.width())/2).toString()+"px",top:((p.height-v.height())/2).toString()+"px"})}},200)}})},setOverlayVisibility:function(e,t){var n=t?"show":"hide";if(jc2cui.mapWidget.renderer){jc2cui.mapWidget.renderer.setOverlayVisibility(e,t)}OWF.Eventing.publish("map.overlay."+n,JSON.stringify({overlayId:e}))},setFeatureVisibility:function(e,t,n){var r=n?"show":"hide";if(jc2cui.mapWidget.renderer){if(n){jc2cui.mapWidget.renderer.showFeature({overlayId:e,featureId:t})}else{jc2cui.mapWidget.renderer.hideFeature({overlayId:e,featureId:t})}}OWF.Eventing.publish("map.feature."+r,JSON.stringify({overlayId:e,featureId:t}))},setItemVisibility:function(e,t,n){if(jc2cui.mapWidget.renderer){if(n){jc2cui.mapWidget.renderer.showItem({overlayId:e,itemId:t})}else{jc2cui.mapWidget.renderer.hideItem({overlayId:e,itemId:t})}}},itemSelected:function(e){if(!e.selectedId&&!e.selectedName){console.log("mapWidget not sending selection for item with no selectedId or selectedName");return}OWF.Eventing.publish("map.feature.selected",JSON.stringify(e))},mapClicked:function(e,t,n,r,i,s,o){var u=[];if(i){u.push("shift")}if(s){u.push("ctrl")}if(o){u.push("alt")}OWF.Eventing.publish("map.view.clicked",JSON.stringify({lat:e,lon:t,type:n===2?"double":"single",button:r===3?"right":r==="2"?"middle":"left",keys:u}))},publishView:function(e){var t=JSON.stringify(e);OWF.Eventing.publish("map.status.view",t);OWF.Preferences.setUserPreference({namespace:r,name:"view",value:t,onFailure:function(e,t){T("Error updating preferences. Status Code: "+t+" . Error message: "+e)}})},createViewStatus:function(e,t,n,r,i,s,o){return st(e,t,n,r,i,s,o)},removeOverlay:function(e){if(jc2cui.mapWidget.renderer){jc2cui.mapWidget.renderer.removeOverlay(e)}if(t.sidebar){jc2cui.mapWidget.sidebar.removeOverlay(e)}if(e===jc2cui.mapWidget.USER_DRAWN_OVERLAY){i=false}OWF.Eventing.publish("map.overlay.remove",JSON.stringify({overlayId:e}))},removeFeature:function(e,n){if(jc2cui.mapWidget.renderer){jc2cui.mapWidget.renderer.removeFeature({overlayId:e,featureId:n})}if(t.sidebar){jc2cui.mapWidget.sidebar.removeFeature(n,e)}OWF.Eventing.publish("map.feature.unplot",JSON.stringify({overlayId:e,featureId:n}))},showError:function(e){T(e)},showDialog:S,error:function(e){if(console){console.log(e)}OWF.Eventing.publish("map.error",JSON.stringify(e));if(e.sender.id==="userLoaded"){T("Unable to load KML. Is URL correct?"+"<br/>"+e.error)}},getNewId:function(){return n+"."+ ++s},publishDrawing:function(e,n,r,s){var o;if(!i){if(t.sidebar){A(jc2cui.mapWidget.USER_DRAWN_OVERLAY)}OWF.Eventing.publish("map.overlay.create",JSON.stringify({overlayId:jc2cui.mapWidget.USER_DRAWN_OVERLAY}));i=true}if(t.sidebar){o={title:r||"kml",tooltip:"click to zoom to",key:n,select:s!==undefined?s:true,isFeature:true};ot(o,jc2cui.mapWidget.USER_DRAWN_OVERLAY)}OWF.Eventing.publish("map.feature.plot",JSON.stringify({overlayId:jc2cui.mapWidget.USER_DRAWN_OVERLAY,featureId:n,name:r,feature:e}))},deleteDrawing:function(e){var t={overlayId:jc2cui.mapWidget.USER_DRAWN_OVERLAY,featureId:e},r=JSON.stringify(t);q(t,[],{id:n+".userdrawn"},r);OWF.Eventing.publish("map.feature.unplot",r)},rendererReady:function(e){var n;if(t.sidebar){jc2cui.mapWidget.sidebar.init(t.sidebar)}if(e){for(n=0;n<e.length;n++){ut(e[n])}}OWF.Preferences.getUserPreference({namespace:r,name:"view",onSuccess:function(e){if(e&&e.value){var t=JSON.parse(e.value);t.zoom=t.range||"auto";J(t,{})}},onFailure:function(e,t){if(t!==undefined&&e!=="undefined : undefined"){T("Got an error getting preferences! Status Code: "+t+" . Error message: "+e)}}});Y()},getAppPath:function(){return document.location.href.replace(/\/[^\/]*$/,"/")},getDefaultDrawingIcon:function(){if(!o){o=[jc2cui.mapWidget.getAppPath(),"images/blu-circle.png"].join("")}return o},getDefaultIcon:function(){if(!u){u=[jc2cui.mapWidget.getAppPath(),"images/ylw-pushpin.png"].join("")}return u},getErrorIcon:function(){if(!a){a=[jc2cui.mapWidget.getAppPath(),"images/error-pushpin.png"].join("")}return a},showPlacemarkInfoWindow:function(e,t){var n=e.name||e.title||"[no name]",r=e.description,i,s,o,u,a;if(e.style&&e.style.BalloonStyle&&e.style.BalloonStyle.text){if(typeof e.style.BalloonStyle.text==="string"){r=e.style.BalloonStyle.text}else if(e.style.BalloonStyle.text["#cdata-section"]){r=e.style.BalloonStyle.text["#cdata-section"]}r=r.replace("$[description]",e.description);r=r.replace("$[name]",n);r=r.replace("$[id]",e.id);if(e.extendedData){r=r.replace(/\$\[([\w.]+?)\]/g,function(t,n){return e.extendedData[n]})}i=e.style.BalloonStyle.bgColor;s=e.style.BalloonStyle.textColor}if((!r||!r.length)&&e.extendedData){r=['<table border="1" cellpadding="3">'];$.each(e.extendedData,function(e,t){r.push("<tr><td>");r.push(e);r.push("</td><td>");r.push(t);r.push("</td></tr>")});r.push("</table>");r=r.join("")}u=['<div class="contents"><h3><span id="name"></span>'];if(t){u.push('<img src="images/back.png" alt="back" title="back" class="back">')}u.push('</h3><div id="description" class="desc">');u.push('</div><div class="zoom"><span id="zoom" class="button">zoom to item</span></div></div>');a=$(u.join(""));$("#name",a).text(n||"");$("#description",a).append($.parseHTML(r,true));o={content:a,bgColor:i,textColor:s};$("#zoom",o.content).click(function(){jc2cui.mapWidget.renderer.fitToBounds(e.getBounds());jc2cui.mapWidget.infoWindow.close()});$(".back",o.content).click(function(){jc2cui.mapWidget.showClusterInfoWindow(t)});jc2cui.mapWidget.infoWindow.close();jc2cui.mapWidget.infoWindow.open(o,e)},showUserDrawnEditWindow:function(e,t){var n={deleted:function(){jc2cui.mapWidget.infoWindow.close();if(t.deleted){t.deleted()}},updated:function(e){jc2cui.mapWidget.infoWindow.close();if(t.updated){t.updated(e)}},canceled:function(){jc2cui.mapWidget.infoWindow.close();if(t.canceled){t.canceled()}}},r=jc2cui.mapWidget.featureEditor.getEditFeatureHtml(e,n);jc2cui.mapWidget.infoWindow.open({content:r,width:"256px",height:"206px"},e)},showClusterInfoWindow:function(e){var t=$('<div class="contents"><h3><span id="name">'+e.name+'</span></h3><div id="description" class="desc"></div><div class="zoom"><span id="zoom" class="button">zoom to cluster</span></div></div>'),n=$("#description",t),r=["<ul>"],i,s;if(e.placemarks){i=e.placemarks.slice();i.sort(function(t,n){t=t[e.attributes].name||t[e.attributes].title||"[no name]";n=n[e.attributes].name||n[e.attributes].title||"[no name]";if(t<n){return-1}if(t>n){return 1}return 0});for(s=0;s<i.length;s++){r.push('<li><a href="" id="');r.push(s);r.push('" class="placemark">');r.push(i[s][e.attributes].name||i[s][e.attributes].title||"[no name]");r.push("</a></li>")}}r.push("</ul>");n.append(r.join(""));$(".placemark",n).click(function(t){var n=$(this).attr("id"),r={selectedId:i[n][e.attributes].id||undefined,selectedName:i[n][e.attributes].name||undefined},s=i[n][e.attributes].parent;while(s){if(s.featureId){r.featureId=s.featureId;r.overlayId=s.overlayId;break}s=s.parent}jc2cui.mapWidget.showPlacemarkInfoWindow(i[n][e.attributes],e);jc2cui.mapWidget.itemSelected(r);t.preventDefault()});$("#zoom",t).click(function(){jc2cui.mapWidget.renderer.fitToBounds(e.bounds);jc2cui.mapWidget.infoWindow.close()});jc2cui.mapWidget.infoWindow.close();jc2cui.mapWidget.infoWindow.open({content:t})},addTreeItems:function(e,t,n,r){ot(e,t,n,r)},totalMarkersLoaded:function(e){if(e>0&&e!==g){g=e;m.text(e+" entities now loaded").show().stop().css("opacity","1").fadeOut(3e3,function(){m.hide()})}},options:function(){return t.options||{}},USER_DRAWN_OVERLAY:"User drawn"},e)}(jc2cui.mapWidget||{});$(document).ready(function(){"use strict";$.ajaxSetup({cache:false});var e="config/owfConfig.json";$.ajax({url:e,dataType:"json",success:function(e){if(!e){jc2cui.mapWidget.showError("Error loading map widget configuration: No data");return}jc2cui.mapWidget.init(e)},error:function(t,n,r){var i="Error loading map widget configuration: "+e;if(n&&n!=="error"){i+=" "+n}jc2cui.mapWidget.showError(i)}})})