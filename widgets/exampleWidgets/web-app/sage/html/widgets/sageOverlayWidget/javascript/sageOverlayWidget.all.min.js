var jc2cui=jc2cui||{};
jc2cui.sageOverlayWidget=function(){function p(h){try{return(new XMLSerializer).serializeToString(h)}catch(a){try{return h.xml}catch(f){alert("Xmlserializer not supported")}}return!1}function k(h,a){var f=h;i.proxy&&(f=i.proxy+encodeURIComponent(f));$.ajax({url:f,dataType:"xml",cache:!1,success:function(e){a(e)},error:function(a,d){var g="Error loading data from: "+h;d&&"error"!==d&&(g+=" "+d);Ozone.util.ErrorDlg.show("Error",g)}})}function l(h,a){if(h.jQuery){var f=h.jQuery,e=m.getRoot(),d=[e];e.removeChildren();
f("body>blockquote").prev().each(function n(a,c){var b=f(c),e=b.text(),g=[1<d.length?d[d.length-1].data.key:u,".",e].join("");d.push(d[d.length-1].addChild({title:e,isFolder:!0,expand:!0,key:g}));0<b.next().children().length&&"A"===b.next().children().first()[0].tagName?(f("a",b.next()).each(function(b,c){var a=f(c),e=a.text(),g=[1<d.length?d[d.length-1].data.key:u,".",e].join("");d[d.length-1].addChild({title:e,isFolder:!1,expand:!0,key:g,href:a.attr("href"),select:!0===r[g]})}),d.pop()):b.next().children("blockquote").prev().each(n)});
s=[];var g=m.getRoot(),c;g.visit(function(a){a.data.isFolder&&(c=a.getParent(),c!==g&&-1===$.inArray(c,s)&&s.push(c))});if(a.length){q=[];var b=m.getRoot().getChildren()[0].data.key;a.each(function(a,c){q.push({featureId:w+a,name:"SAGE Logo",feature:p(c),overlayId:b})});q=JSON.stringify(q)}}else setTimeout(function(){l(h,a)},200)}function v(h,a,f){if(t===a)t=null;else{var e,f=f||{};if(h)if(a.data.isFolder)a.visit(function(a){v(h,a,f)});else{var d=a.getParent();e=f;var g=[d],c=[],b,i,n;d.visitParents(function(a){0!==
a.getLevel()&&g.push(a)},!1);if(d.hasSubSel){for(;0<g.length;)d=g.pop(),n=d.data.key,b=e[n],b||(b={overlayId:n,name:d.data.title},i&&(b.parentId=i.overlayId),c.push(b),e[n]=b),i=b;0<c.length&&j.publish("map.overlay.create",JSON.stringify(c))}r[a.data.key]=!0;j.publish("map.feature.plot",q);j.publish("map.feature.plot.url",JSON.stringify({featureId:a.data.key,name:a.data.title,url:a.data.href,overlayId:a.getParent().data.key,zoom:!0}))}else{a.data.isFolder||(delete r[a.data.key],j.publish("map.feature.unplot",
JSON.stringify({featureId:a.data.key,overlayId:a.getParent().data.key})));for(e=a.getParent();0<e.getLevel()&&!e.hasSubSel;)a=e,e=e.getParent();a.data.isFolder&&!a.hasSubSel&&j.publish("map.overlay.remove",JSON.stringify({overlayId:a.data.key}))}}}var i,j,m,t,u,r={},w="SAGE",q,s=[];return{init:function(h){i=h;if(i.owf){var a=jQuery;$.ajax({url:i.owf+"/js-min/owf-widget-min.js",dataType:"script",cache:!0,timeout:2E4,success:function(){if("object"!==typeof Ozone||!Ozone.util.isRunningInOWF())alert("SAGE Overlay Widget only works as a widget in an OWF dashboard");
else{var f,e;$=jQuery=a||jQuery;owfdojo.config.dojoBlankHtmlUrl="../jc2cui-common/common/javascript/dojo-1.5.0-windowname-only/dojo/resources/blank.html";if(i.owfRelay){try{Ozone.eventing.Widget.widgetRelayURL=i.owfRelay,j=Ozone.eventing.Widget.getInstance()}catch(d){e="Error setting up OWF eventing",d&&(e+=": "+d),Ozone.util.ErrorDlg.show(e)}(new Ozone.chrome.WidgetChrome({widgetEventingController:j})).insertHeaderButtons({items:[{type:"help",itemId:"help",handler:function(){Ozone.util.ErrorDlg.show("JC2CUI SAGE Overlay Widget")}}]});
f=JSON.parse(j.getWidgetId()).id;u="jc2cui.overlayWidget."+f;j.subscribe("map.overlay.remove",function(a,c){var b;JSON.parse(a).id!==f&&(b="string"===typeof c?JSON.parse(c):c,$.isArray(b)||(b=[b]),$.each(b,function(a,c){var b=m.getNodeByKey(c.overlayId);b&&b.visit(function(a){a.data.isFolder||(t=a,a.select(!1))},!1)}))});j.subscribe("map.feature.unplot",function(a,c){var b;JSON.parse(a).id!==f&&(b="string"===typeof c?JSON.parse(c):c,$.isArray(b)||(b=[b]),$.each(b,function(a,c){var b=c.featureId;delete r[b];
if(b=m.getNodeByKey(b))t=b,b.select(!1)}))});i.sageRoot?(m=$("#sage").dynatree({checkbox:!0,selectMode:3,clickFolderMode:1,persist:!1,debugLevel:0,onDblClick:function(a){a.toggleSelect()},onKeydown:function(a,c){if(32===c.which)return a.toggleSelect(),!1},onQuerySelect:function(a,c){if(a&&-1<$.inArray(c,s))return!1},onSelect:v}).dynatree("getTree"),k(i.sageRoot,function(a){var c,b;$(a).find("NetworkLink").each(function(){c={name:$(this).children("name").text()};$(this).find("Url").each(function(){c.href=
$(this).children("href").text();c.refreshInterval=$(this).children("refreshInterval").text()})});c&&(b=function(){k(c.href,function(a){var b=document.getElementById("sageLoaderIframe"),c=$("description",a).text(),a=$(a).find("ScreenOverlay"),c=c.replace(/<\/body>/,'<script type="text/javascript" src="../jc2cui-common/common/javascript/jquery-1.8.2.js"><\/script></body>'),c=c.substr(c.indexOf("<html")),b=b.contentWindow||b.contentDocument.document||b.contentDocument;b.document.open();b.document.write(c);b.document.close();
l(b,a)});c.refreshInterval&&setTimeout(b,1E3*c.refreshInterval)},b())})):Ozone.util.ErrorDlg.show("Error","Missing sageRoot attribute in config file.")}else Ozone.util.ErrorDlg.show("Missing owfRelay configuration attribute in config file.")}},error:function(a,e){var d="Error loading OWF script "+i.owf;e&&"error"!==e&&(d+=": "+e);alert(d)}})}else alert("Error","Missing owf configuration attribute in config file.")}}}();
$(document).ready(function(){$.ajax({url:"html/widgets/sageOverlayWidget/config/sageOverlayWidgetConfig.json",dataType:"json",success:function(p){p?jc2cui.sageOverlayWidget.init(p):alert("Error loading sage overlay widget configuration: No data")},error:function(p,k){var l="Error loading sage overlay widget configuration: config/sageOverlayWidgetConfig.json";k&&"error"!==k&&(l+=" "+k);alert(l)}})});
